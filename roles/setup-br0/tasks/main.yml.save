---
- name: install packages
  package:
    name: bridge-utils, NetworkManager-libnm, python3-networkmanager
    state: latest

#
# nmcli stuff is BROKEN due to https://github.com/ansible/ansible/issues/48055
#

- name: configure eth0 for Jumbo Frames
  nmcli:
    conn_name: eth0
    ifname: eth0
    mtu: 9000
    type: ethernet
    state: present

- name: configure {{primary_bridge}}
  nmcli:
    conn_name: "{{primary_bridge}}"
    ifname: "{{primary_bridge}}"
    type: bridge
    ip4: 172.16.1.3/24
    gw4: 172.16.1.1
    dns4: 
      - 172.16.1.3
      - 172.16.1.1
      - 8.8.8.8
    mtu: 9000
    state: present
  notify: restart network

- name: add eth0 to {{primary_bridge}}
  nmcli: 
    type: bridge
    conn_name: br0_slave_0
    ifname: eth0
    master: "{{primary_bridge}}"
    state: present

- firewalld:
    zone: "{{public_firewall_zone}}"
    interface: "{{primary_bridge}}"
    permanent: true
    state: enabled

- name: Set ip forwarding and reload if necessary
  sysctl:
    name: net.ipv4.ip_forward
    value: 1
    sysctl_set: yes
    state: present
    reload: yes
